"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[51],{2051:function(t,e,n){n.d(e,{default:function(){return d}});var s=n(7437),a=n(2265),l=n(6463),r=n(6264),i=n(9233);function o(t){let{original:e,edited:n,titleLeft:a="元の内容",titleRight:l="現在の内容"}=t;return(0,s.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[(0,s.jsxs)("div",{className:"card",style:{padding:12},children:[(0,s.jsx)("div",{style:{fontSize:12,color:"#555",marginBottom:8},children:a}),(0,s.jsx)("div",{style:{maxHeight:260,overflow:"auto"},children:(0,s.jsx)(i.Z,{content:e||""})})]}),(0,s.jsxs)("div",{className:"card",style:{padding:12},children:[(0,s.jsx)("div",{style:{fontSize:12,color:"#555",marginBottom:8},children:l}),(0,s.jsx)("div",{style:{maxHeight:260,overflow:"auto"},children:(0,s.jsx)(i.Z,{content:n||""})})]})]})}function c(t){let{company:e,item:n,isRunning:l,onSaved:c,onRerun:d}=t,[u,h]=(0,a.useState)(n.markdown||n.text||""),[m,p]=(0,a.useState)(n.markdown||n.text||""),[x,f]=(0,a.useState)(!1),[g,y]=(0,a.useState)(!1),[j,v]=(0,a.useState)(null);async function w(){f(!0),v(null);try{await (0,r.sg)("/api/results/".concat(encodeURIComponent(e),"/").concat(n.index,"/edit"),{text:u,markdown:u}),p(u),c()}catch(t){t instanceof Error&&v(t.message)}finally{f(!1)}}async function E(){y(!0),v(null);try{await d(n.index)}catch(t){t instanceof Error&&v(t.message)}finally{y(!1)}}(0,a.useEffect)(()=>{let t=n.markdown||n.text||"";h(t),p(t)},[n.index,n.markdown,n.text]);let b=n.edited;return(0,s.jsxs)("div",{className:"card",style:{marginBottom:16,padding:16},children:[(0,s.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:12,flexWrap:"wrap"},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,s.jsx)("span",{style:{fontWeight:600},children:n.title}),b&&(0,s.jsx)("span",{className:"pill pill-success",children:"編集あり"}),!b&&n.text&&(0,s.jsx)("span",{className:"pill",children:"未編集"}),n.historyCount?(0,s.jsxs)("span",{className:"pill pill-ghost",children:["履歴 ",n.historyCount]}):null]}),(0,s.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,s.jsx)("button",{className:"btn",onClick:function(){let t=n.originalMarkdown||n.originalText||"";h(t),p(t)},disabled:x||g||l,children:"元に戻す"}),(0,s.jsx)("button",{className:"btn",onClick:E,disabled:x||g||l,children:g?"再実行中…":"再実行"}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:w,disabled:x||g,children:x?"保存中…":"保存"})]})]}),(0,s.jsx)("div",{style:{height:8}}),(0,s.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{style:{fontSize:12,color:"#555",marginBottom:4},children:"編集"}),(0,s.jsx)("textarea",{value:u,onChange:t=>h(t.target.value),rows:12,style:{width:"100%",resize:"vertical"},disabled:x||g})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{style:{fontSize:12,color:"#555",marginBottom:4},children:"プレビュー"}),(0,s.jsx)("div",{className:"card",style:{padding:8,maxHeight:280,overflow:"auto"},children:(0,s.jsx)(i.Z,{content:m})})]})]}),(0,s.jsx)("div",{style:{height:12}}),(0,s.jsx)(o,{original:n.originalMarkdown||n.originalText||"",edited:u}),j&&(0,s.jsx)("div",{className:"alert",style:{marginTop:12},children:j})]})}function d(t){var e,n;let{company:i}=t,o=(0,l.useRouter)(),[d,u]=(0,a.useState)(null),[h,m]=(0,a.useState)(!1),[p,x]=(0,a.useState)(null);async function f(){x(null);try{let t=await (0,r.R1)("/api/results/".concat(encodeURIComponent(i)));u(t)}catch(t){t instanceof Error&&x(t.message)}}(0,a.useEffect)(()=>{f();let t=setInterval(f,1e4);return()=>clearInterval(t)},[i]);let g=(null==d?void 0:d.status)==="running",y=(null==d?void 0:null===(e=d.items)||void 0===e?void 0:e.some(t=>t.text&&t.text.trim()||t.markdown&&t.markdown.trim()))||!1,j=!g&&y,v=(0,a.useCallback)(async t=>{m(!0),x(null);try{await (0,r.sg)("/api/results/".concat(encodeURIComponent(i),"/").concat(t,"/rerun"),{})}catch(t){t instanceof Error&&x(t.message)}finally{m(!1),f()}},[i]),w=(0,a.useCallback)(()=>{f()},[i]);return(0,s.jsxs)("div",{className:"container",children:[(0,s.jsxs)("div",{className:"card",style:{padding:16,marginBottom:16,display:"flex",flexDirection:"column",gap:8},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"},children:[(0,s.jsx)("h1",{style:{margin:0},children:i}),g&&(0,s.jsx)("span",{className:"pill",children:"実行中"}),!g&&(null==d?void 0:d.status)==="completed"&&(0,s.jsx)("span",{className:"pill pill-success",children:"完了"}),!g&&(null==d?void 0:d.status)==="not_found"&&(0,s.jsx)("span",{className:"pill",children:"未実行"})]}),(null==d?void 0:d.progress)&&(0,s.jsxs)("p",{className:"muted",style:{margin:0},children:["進捗: ",d.progress.completed," / ",d.progress.total]}),(0,s.jsxs)("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[(0,s.jsx)("button",{className:"btn",onClick:()=>o.push("/"),children:"← 戻る"}),j&&(0,s.jsx)("button",{className:"btn btn-primary",onClick:()=>o.push("/company/".concat(encodeURIComponent(i),"/proposal")),children:"提案を作成"}),(null==d?void 0:d.hasProposal)&&(0,s.jsx)("button",{className:"btn",onClick:()=>o.push("/company/".concat(encodeURIComponent(i),"/proposal")),children:"提案を見る"})]}),(g||h)&&(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,s.jsx)("div",{className:"spinner"}),(0,s.jsx)("span",{children:"バックグラウンドで処理中です…"})]}),p&&(0,s.jsx)("div",{className:"alert",children:p})]}),(null==d?void 0:null===(n=d.items)||void 0===n?void 0:n.length)?d.items.map(t=>(0,s.jsx)(c,{company:i,item:t,isRunning:!!g,onSaved:w,onRerun:v},t.index)):(0,s.jsx)("p",{className:"muted",children:"結果がありません。"})]})}},9233:function(t,e,n){n.d(e,{Z:function(){return r}});var s=n(7437);n(2265);var a=n(27),l=n(7601);function r(t){let{content:e}=t;return(0,s.jsx)(a.U,{remarkPlugins:[l.Z],components:{a:t=>{let{node:e,...n}=t;return(0,s.jsx)("a",{...n})},h1:t=>{let{node:e,...n}=t;return(0,s.jsx)("h2",{...n})},h2:t=>{let{node:e,...n}=t;return(0,s.jsx)("h3",{...n})}},children:e||""})}},6264:function(t,e,n){async function s(t){try{let e=await fetch(t,{next:{revalidate:0}});if(!e.ok){let n="GET ".concat(t," ").concat(e.status);try{let t=await e.json();t.detail&&(n=t.detail)}catch(s){n="GET ".concat(t," ").concat(e.status," ").concat(e.statusText)}throw Error(n)}return e.json()}catch(t){if(t instanceof Error){if(t.message.includes("Failed to fetch")||t.message.includes("NetworkError"))throw Error("ネットワークエラーが発生しました。接続を確認してください。");throw t}throw Error("予期しないエラーが発生しました")}}async function a(t,e,n){let s=(null==n?void 0:n.timeout)||6e5,a=null==n?void 0:n.signal,l=new AbortController,r=setTimeout(()=>l.abort(),s);a&&a.addEventListener("abort",()=>{l.abort()});try{let n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:l.signal});if(clearTimeout(r),!n.ok){let e="POST ".concat(t," ").concat(n.status);try{let t=await n.json();t.detail&&(e=t.detail)}catch(s){e="POST ".concat(t," ").concat(n.status," ").concat(n.statusText)}throw Error(e)}return n.json()}catch(t){if(clearTimeout(r),t instanceof Error){if("AbortError"===t.name){if(null==a?void 0:a.aborted)throw Error("リクエストがキャンセルされました");throw Error("リクエストがタイムアウトしました。時間がかかりすぎている可能性があります。しばらく待ってから再試行してください。")}if(t.message.includes("Failed to fetch")||t.message.includes("NetworkError"))throw Error("ネットワークエラーが発生しました。接続を確認してください。");throw t}throw Error("予期しないエラーが発生しました")}}async function l(t){try{let e=await fetch(t,{method:"DELETE"});if(!e.ok){let n="DELETE ".concat(t," ").concat(e.status);try{let t=await e.json();t.detail&&(n=t.detail)}catch(s){n="DELETE ".concat(t," ").concat(e.status," ").concat(e.statusText)}throw Error(n)}return e.json()}catch(t){if(t instanceof Error){if(t.message.includes("Failed to fetch")||t.message.includes("NetworkError"))throw Error("ネットワークエラーが発生しました。接続を確認してください。");throw t}throw Error("予期しないエラーが発生しました")}}n.d(e,{QW:function(){return l},R1:function(){return s},sg:function(){return a}})}}]);